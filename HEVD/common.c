#include "includes/common.h"

ULONGLONG GetKernelBase(void)
{
	/*
	 * Get base address of kernel via EnumDeviceDrivers() API.
	 * 
	 * @returns ntoskrnl.exe base address.
	 */

	LPVOID	lpImageBase[1024] = {0};
	DWORD	lpcbNeeded;

	printf("\t[*] Obtaining Kernel Base address!\n");
	BOOL DevicesDrivers = EnumDeviceDrivers(lpImageBase, sizeof(lpImageBase), &lpcbNeeded);
	if (!DevicesDrivers)
	{
		printf("\t[!] FATAL: Error obtaining devices drivers!\n");
		EXIT_FAILURE;
	}

	/* Get first entry in list (ntoskrnl.exe) */
	char BaseName[1024] = { 0 };
	BOOL DeviceDriversBaseName = GetDeviceDriverBaseName(lpImageBase[0], BaseName, sizeof(BaseName));
	if (!DeviceDriversBaseName)
	{
		printf("\t[!] FATAL: Error getting device drivers base name!\n");
		EXIT_FAILURE;
	}

	/* ntoskrnl.exe is first module in lpImageBase */
	ULONGLONG KernelBaseAddress = (ULONGLONG)lpImageBase[0];

	printf("\t[+] Kernel Base Name is: %s\n", BaseName);
	printf("\t[+] %s is located at 0x%p\n", BaseName, KernelBaseAddress);
	return KernelBaseAddress;
}

HANDLE GetDeviceHandle(void)
{
	/*
	 * Create handle to driver through CreateFileA() API.
	 * 
	 * @returns A handle to the target driver.
	 */

	HANDLE	DeviceHandle = 0;
	
	printf("[*] Opening handle to %s\n", DRIVER);
	DeviceHandle = CreateFileA(DRIVER, GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
	if (DeviceHandle == INVALID_HANDLE_VALUE)
	{
		printf("\t[!] FATAL: Could not open handle!\n");
		EXIT_FAILURE;
	}

	return DeviceHandle;
}
